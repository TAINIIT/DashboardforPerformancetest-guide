<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analysis Dashboard Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background 1s ease-in-out;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            flex-grow: 1;
        }
        #bg-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: -2;
            filter: blur(2px) brightness(0.7);
        }
        #bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.4);
            transition: background-color 1s ease-in-out;
            z-index: -1;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 45vh;
            width: 100%;
        }
        .error-row {
            background-color: #fee2e2; /* red-100 */
        }
        .error-row:hover {
            background-color: #fecaca; /* red-200 */
        }
        .threshold-exceeded-row {
            background-color: #fef9c3; /* yellow-100 */
        }
        .threshold-exceeded-row:hover {
            background-color: #fef08a; /* yellow-200 */
        }
        .summary-card {
            transition: all 0.3s ease-in-out;
            animation: fadeIn 0.5s ease-in-out;
            background-color: rgba(255, 255, 255, 0.9);
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .content-card {
             background-color: rgba(255, 255, 255, 0.9);
        }
        .assistant-tip {
            background-color: #e0f2fe; /* light-blue-100 */
            border-left: 4px solid #0ea5e9; /* sky-500 */
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #0c4a6e; /* sky-800 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Timeline Slider Styles */
        #timeline-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd; /* Fallback */
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s, background .1s linear;
            border-radius: 5px;
        }
        #timeline-slider:hover {
            opacity: 1;
        }
        #timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #0ea5e9; /* sky-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        #timeline-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #0ea5e9; /* sky-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="text-gray-200">

    <video id="bg-video" autoplay loop muted playsinline>
        <source src="https://assets.mixkit.co/videos/preview/mixkit-container-ship-sailing-in-the-ocean-3563-large.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div id="bg-overlay"></div>
    
    <div class="fixed top-4 right-4 z-50">
        <select id="language-selector" class="bg-white text-gray-800 rounded-md shadow-lg p-2">
            <option value="en">English</option>
            <option value="vi">Tiếng Việt</option>
        </select>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 relative z-10">
        <header class="text-center mb-8 pt-16">
            <h1 class="text-3xl sm:text-4xl font-bold text-white" data-translate-key="dashboardTitle">Performance Analysis Dashboard Tool</h1>
            <p class="text-md text-gray-300 mt-2" data-translate-key="dashboardSubtitle">Upload a results file (.jmx, .csv, .json) to explore performance data.</p>
        </header>

        <!-- Collapsible Setup & Filters Section -->
        <div id="main-controls-container" class="max-w-5xl mx-auto mb-8">
            <div id="main-controls-header" class="flex justify-between items-center p-4 bg-gray-800 bg-opacity-50 rounded-lg cursor-pointer">
                <h2 class="text-xl font-semibold text-white" data-translate-key="setupAndFiltersTitle">Setup, Filters & Export</h2>
                <svg id="main-controls-arrow" class="w-6 h-6 text-white transition-transform transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div id="main-controls-content" class="pt-4">
                <!-- Main Action Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center mb-8">
                    <!-- File Upload Section -->
                    <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                        <label for="file-upload-label" class="block text-lg font-semibold text-gray-800 mb-2" data-translate-key="uploadTitle">Upload Results File(s)</label>
                        <div class="flex items-center justify-center w-full">
                            <label id="file-upload-label" for="file-upload" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-400 border-dashed rounded-lg cursor-pointer bg-gray-200 hover:bg-gray-300 transition">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <p class="mb-2 text-sm text-gray-600"><span class="font-semibold" data-translate-key="clickToUpload">Click to upload</span> <span data-translate-key="orDragAndDrop">or drag and drop</span></p>
                                    <p class="text-xs text-gray-600" data-translate-key="supportedFiles">Supports .jmx, .csv, .json files</p>
                                </div>
                                <input id="file-upload" type="file" class="hidden" accept=".jmx,.csv,.json" multiple />
                            </label>
                        </div>
                        <p id="file-name" class="mt-4 text-center text-sm text-gray-700"></p>
                    </div>
                    <!-- Understand Chart Button Section -->
                    <div class="content-card text-center p-6 rounded-lg shadow-md border border-gray-700 flex flex-col items-center justify-center h-full">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate-key="helpTitle">Need help reading the charts?</h3>
                        <p class="text-gray-700 mb-6 text-center" data-translate-key="helpSubtitle">Click the button below for a detailed guide on how to interpret the performance data.</p>
                        <button id="understand-chart-btn" class="bg-teal-500 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-teal-600 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" data-translate-key="understandChartsBtn">
                            Understand The Charts
                        </button>
                    </div>
                </div>
                <!-- Filters Section -->
                <div id="filters-section" class="content-card rounded-lg shadow-md p-6 border border-gray-700 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900" data-translate-key="filtersTitle">Data Filters & Export</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 items-end">
                            <div>
                                <label for="label-filter" class="block text-sm font-medium text-gray-900" data-translate-key="filterByLabel">Filter by Label</label>
                                <select id="label-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md text-gray-900"></select>
                            </div>
                            <div>
                                <label for="status-filter" class="block text-sm font-medium text-gray-900" data-translate-key="filterByStatus">Filter by Status</label>
                                <select id="status-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md text-gray-900">
                                    <option value="all" data-translate-key="statusAll">All</option>
                                    <option value="true" data-translate-key="statusSuccess">Success</option>
                                    <option value="false" data-translate-key="statusFailure">Failure</option>
                                </select>
                            </div>
                            <div>
                                <label for="threshold-input" class="block text-sm font-medium text-gray-900" data-translate-key="responseTimeThreshold">Threshold (ms)</label>
                                <input type="number" id="threshold-input" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md text-gray-900" placeholder="e.g., 2000">
                            </div>
                            <div>
                                <button id="apply-filters-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-semibold" data-translate-key="applyBtn">Apply</button>
                            </div>
                            <div class="flex justify-center pb-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="toggle-tips" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                                    <label for="toggle-tips" class="ml-2 text-sm font-medium text-gray-900" data-translate-key="showAssistantTips">Show Assistant Tips</label>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="export-pdf-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" data-translate-key="exportPdfBtn">Export PDF</button>
                            <button id="tsb-analysis-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500" data-translate-key="tsbAnalysisBtn">✨ Analyze with TSB</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Replay Timeline Section -->
        <div id="timeline-container" class="max-w-5xl mx-auto content-card rounded-lg shadow-md p-6 border border-gray-700 mb-8 hidden">
             <div class="flex justify-between items-center mb-2">
                <label for="timeline-slider" class="text-lg font-semibold text-gray-900" data-translate-key="replayTimelineTitle">Replay Timeline</label>
                <span id="timeline-label" class="text-sm font-mono text-gray-700"></span>
            </div>
            <input type="range" id="timeline-slider" min="0" max="100" value="100">
        </div>

        <!-- Data Display Section -->
        <div id="dashboard-content" class="mt-10 hidden">
            <!-- Performance Summary Cards -->
            <div id="summary-stats" class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center mb-8"></div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 gap-8 mb-8 text-gray-800">
                <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-center" data-translate-key="responseTimeChartTitle">Response Time Over Time (by Label)</h2>
                        <button onclick="downloadChart('response-time-over-time-chart', 'response-time-over-time.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm" data-translate-key="savePngBtn">Save PNG</button>
                    </div>
                    <div id="response-time-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="response-time-over-time-chart"></canvas></div>
                </div>
                <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-center" data-translate-key="throughputChartTitle">Throughput (Requests/sec)</h2>
                        <button onclick="downloadChart('throughput-chart', 'throughput.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm" data-translate-key="savePngBtn">Save PNG</button>
                    </div>
                     <div id="throughput-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="throughput-chart"></canvas></div>
                </div>
                 <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-center" data-translate-key="percentilesChartTitle">90th/95th Percentiles by Label</h2>
                        <button onclick="downloadChart('percentile-chart', 'percentiles.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm" data-translate-key="savePngBtn">Save PNG</button>
                    </div>
                     <div id="percentile-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="percentile-chart"></canvas></div>
                </div>
                 <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4 w-full">
                        <h2 class="text-xl font-semibold text-center" data-translate-key="errorDistributionChartTitle">Error Distribution by Label</h2>
                        <button onclick="downloadChart('error-rate-chart', 'error-distribution.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm" data-translate-key="savePngBtn">Save PNG</button>
                    </div>
                    <div id="error-rate-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="error-rate-chart"></canvas></div>
                </div>
                 <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-center" data-translate-key="successFailTrendChartTitle">Success vs. Failure Trend</h2>
                        <button onclick="downloadChart('success-fail-trend-chart', 'success-fail-trend.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm" data-translate-key="savePngBtn">Save PNG</button>
                    </div>
                    <div id="success-fail-trend-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="success-fail-trend-chart"></canvas></div>
                </div>
            </div>

            <!-- Collapsible Detailed Table Section -->
            <div class="content-card rounded-lg shadow-md border border-gray-700 overflow-hidden text-gray-800">
                 <div id="detailed-data-header" class="flex justify-between items-center p-6 cursor-pointer">
                    <h2 class="text-2xl font-semibold" data-translate-key="detailedDataTitle">Detailed Data</h2>
                    <div class="flex items-center">
                        <button id="download-csv-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 text-sm mr-4" data-translate-key="downloadCsvBtn">Download CSV</button>
                        <svg id="detailed-data-arrow" class="w-6 h-6 text-gray-800 transition-transform transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
                <div id="detailed-data-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableStartTime">Start Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableThreadName">Thread Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableLabel">Label</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableSampleTime">Sample Time (ms)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableStatus">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableBytes">Bytes</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableSentBytes">Sent Bytes</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableLatency">Latency</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableConnectTime">Connect Time (ms)</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls" class="px-6 py-3 flex items-center justify-between border-t border-gray-200"></div>
                </div>
            </div>
        </div>
        <div id="no-data-message" class="text-center mt-10 p-6 content-card rounded-lg shadow-md border border-gray-700 hidden">
            <p class="text-gray-600" data-translate-key="noDataMessage">No valid data found in the uploaded file.</p>
        </div>

        <!-- Start Over Button -->
        <div id="start-over-container" class="text-center mt-10 hidden">
            <button id="start-over-btn" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-600 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" data-translate-key="startOverBtn">
                Start Over
            </button>
        </div>
    </div>

    <!-- Go to Top Button -->
    <button id="go-to-top-btn" class="fixed bottom-8 right-8 bg-sky-500 text-white p-3 rounded-full shadow-lg hover:bg-sky-600 transition hidden" data-translate-key="goToTopBtn" title="Go to top">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </button>

    <!-- Modal for Maximized Chart -->
    <div id="chart-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full h-full max-w-6xl max-h-[90vh] relative">
            <button id="close-modal-btn" class="absolute top-2 right-4 text-gray-600 hover:text-gray-900 text-3xl font-bold">&times;</button>
            <canvas id="maximized-chart-canvas"></canvas>
        </div>
    </div>

     <!-- Modal for Threshold Breaches -->
    <div id="threshold-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] relative flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800" data-translate-key="thresholdBreachesTitle">Threshold Breaches</h2>
                <button id="close-threshold-modal-btn" class="text-gray-600 hover:text-gray-900 text-3xl font-bold">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableStartTime">Start Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableLabel">Label</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableSampleTime">Sample Time (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="threshold-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal for TSB Insights -->
    <div id="tsb-insights-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] relative flex flex-col text-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" data-translate-key="tsbAnalysisTitle">✨ Analyze with TSB</h2>
                <button id="close-tsb-modal-btn" class="text-gray-600 hover:text-gray-900 text-3xl font-bold">&times;</button>
            </div>
            <div id="tsb-insights-content" class="overflow-y-auto flex-grow">
                <!-- TSB insights will be loaded here -->
            </div>
            <div id="tsb-loader" class="flex justify-center items-center h-full">
                <div class="loader"></div>
            </div>
            <div id="tsb-modal-footer" class="mt-4 pt-4 border-t border-gray-200 flex justify-end items-center hidden">
                 <p class="text-sm text-gray-600 text-left mr-auto" data-translate-key="copyInstructions">Click the button to copy the report and open a new Google Doc for pasting.</p>
                 <button id="listen-tsb-report-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-sky-600 transition mr-4 hidden" data-translate-key="listenBtn">🔊 Listen</button>
                 <button id="export-doc-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition" data-translate-key="exportDocBtn">
                    Copy for Google Docs
                </button>
            </div>
        </div>
    </div>

    <footer class="text-center p-4 mt-auto relative z-10 text-white">
        <img src="https://i.postimg.cc/zDwJHp1G/TSB-VIETNAM-80px.png" alt="Logo" class="mx-auto mb-4 w-[35rem]">
        <p id="footer-quote" class="italic text-sm mb-2"></p>
        <p id="footer-copyright" class="text-xs"></p>
    </footer>


    <script>
        // --- GLOBAL STATE & CONFIG ---
        const fileUpload = document.getElementById('file-upload');
        const fileUploadLabel = document.getElementById('file-upload-label');
        const fileNameDisplay = document.getElementById('file-name');
        const dashboardContent = document.getElementById('dashboard-content');
        const noDataMessage = document.getElementById('no-data-message');
        const mainControlsContainer = document.getElementById('main-controls-container');
        const mainControlsHeader = document.getElementById('main-controls-header');
        const mainControlsContent = document.getElementById('main-controls-content');
        const mainControlsArrow = document.getElementById('main-controls-arrow');
        const filtersSection = document.getElementById('filters-section');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const understandChartBtn = document.getElementById('understand-chart-btn');
        const chartModal = document.getElementById('chart-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const maximizedChartCanvas = document.getElementById('maximized-chart-canvas');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const toggleTipsCheckbox = document.getElementById('toggle-tips');
        const thresholdModal = document.getElementById('threshold-modal');
        const closeThresholdModalBtn = document.getElementById('close-threshold-modal-btn');
        const summaryStatsContainer = document.getElementById('summary-stats');
        const tsbAnalysisBtn = document.getElementById('tsb-analysis-btn');
        const tsbInsightsModal = document.getElementById('tsb-insights-modal');
        const closeTsbModalBtn = document.getElementById('close-tsb-modal-btn');
        const tsbInsightsContent = document.getElementById('tsb-insights-content');
        const tsbLoader = document.getElementById('tsb-loader');
        const languageSelector = document.getElementById('language-selector');
        const exportDocBtn = document.getElementById('export-doc-btn');
        const tsbModalFooter = document.getElementById('tsb-modal-footer');
        const bgOverlay = document.getElementById('bg-overlay');
        const timelineContainer = document.getElementById('timeline-container');
        const timelineSlider = document.getElementById('timeline-slider');
        const timelineLabel = document.getElementById('timeline-label');
        const listenTsbReportBtn = document.getElementById('listen-tsb-report-btn');
        const detailedDataHeader = document.getElementById('detailed-data-header');
        const detailedDataContent = document.getElementById('detailed-data-content');
        const detailedDataArrow = document.getElementById('detailed-data-arrow');
        const startOverContainer = document.getElementById('start-over-container');
        const startOverBtn = document.getElementById('start-over-btn');
        const goToTopBtn = document.getElementById('go-to-top-btn');

        let allData = [];
        let filteredData = [];
        let charts = {};
        let maximizedChart;
        let currentPage = 1;
        const rowsPerPage = 20;
        let currentLang = 'en';
        let quoteInterval;

        // --- EVENT LISTENERS ---
        fileUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                handleFile(files[0]); 
            }
        });

        fileUploadLabel.addEventListener('dragover', (event) => {
            event.preventDefault();
            event.stopPropagation();
            fileUploadLabel.classList.add('bg-gray-300');
        });

        fileUploadLabel.addEventListener('dragleave', (event) => {
            event.preventDefault();
            event.stopPropagation();
            fileUploadLabel.classList.remove('bg-gray-300');
        });

        fileUploadLabel.addEventListener('drop', (event) => {
            event.preventDefault();
            event.stopPropagation();
            fileUploadLabel.classList.remove('bg-gray-300');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        understandChartBtn.addEventListener('click', () => {
            const docUrl = 'https://dashboardfor-performancetest-guide.vercel.app/';
            window.open(docUrl, '_blank');
        });

        closeModalBtn.addEventListener('click', () => {
            chartModal.classList.add('hidden');
            if (maximizedChart) {
                maximizedChart.destroy();
            }
        });
        
        closeThresholdModalBtn.addEventListener('click', () => {
            thresholdModal.classList.add('hidden');
        });

        chartModal.addEventListener('click', (event) => {
            if (event.target === chartModal) {
                 chartModal.classList.add('hidden');
                 if (maximizedChart) {
                      maximizedChart.destroy();
                 }
            }
        });
        
        thresholdModal.addEventListener('click', (event) => {
            if (event.target === thresholdModal) {
                 thresholdModal.classList.add('hidden');
            }
        });

        exportPdfBtn.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            pdf.setFontSize(18);
            pdf.text('Performance Analysis Report', 10, 15);

            // --- Render Summary Stats as Text for Sharpness ---
            const summaryCards = summaryStatsContainer.querySelectorAll('.summary-card');
            let xPos = 10;
            const yPos = 30;
            const cardWidth = 55;
            pdf.setFontSize(10);

            summaryCards.forEach((card, index) => {
                const title = card.querySelector('p:first-child').textContent;
                const value = card.querySelector('p:last-child').textContent;
                
                pdf.text(title, xPos, yPos);
                pdf.setFontSize(16);
                pdf.text(value, xPos, yPos + 8);
                pdf.setFontSize(10);
                
                xPos += cardWidth;
            });

            const chartElements = document.querySelectorAll('.chart-container canvas');
            let y = 60; // Adjusted starting Y position

            for (const canvas of chartElements) {
                if (canvas.parentElement.parentElement.style.display !== 'none') {
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const chartHeight = 100;
                    const chartWidth = 277;
                    if (y + chartHeight > 200) {
                        pdf.addPage();
                        y = 10;
                    }
                    pdf.addImage(imgData, 'PNG', 10, y, chartWidth, chartHeight);
                    y += chartHeight + 10;
                }
            }
            pdf.save('performance_report.pdf');
        });

        toggleTipsCheckbox.addEventListener('change', (event) => {
            const tips = document.querySelectorAll('.assistant-tip');
            const isChecked = event.target.checked;
            tips.forEach(tip => {
                if (isChecked && tip.textContent) {
                    tip.style.display = 'block';
                } else {
                    tip.style.display = 'none';
                }
            });
        });

        tsbAnalysisBtn.addEventListener('click', getTsbInsights);
        closeTsbModalBtn.addEventListener('click', () => {
            tsbInsightsModal.classList.add('hidden');
            window.speechSynthesis.cancel(); // Stop speech when closing modal
        });
        
        languageSelector.addEventListener('change', (event) => {
            updateLanguage(event.target.value);
            if (allData.length > 0) {
                updateDashboard();
            }
        });
        
        exportDocBtn.addEventListener('click', () => {
            const reportText = tsbInsightsContent.innerText;
            const footerQuoteText = document.getElementById('footer-quote').innerText;
            const footerCopyrightText = document.getElementById('footer-copyright').innerText;
            const fullTextToCopy = `${reportText}\n\n---\n${footerQuoteText}\n${footerCopyrightText}`;
            
            const textArea = document.createElement("textarea");
            textArea.value = fullTextToCopy;
            
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);

            if (success) {
                const originalText = exportDocBtn.textContent;
                const copiedTextKey = currentLang === 'vi' ? 'copiedToClipboard' : 'copiedToClipboard';
                exportDocBtn.textContent = translations[currentLang][copiedTextKey] || 'Copied!';
                exportDocBtn.disabled = true;
                
                window.open('https://docs.new', '_blank');
                
                setTimeout(() => {
                    exportDocBtn.textContent = originalText;
                    exportDocBtn.disabled = false;
                }, 3000);
            } else {
                alert('Failed to copy. Please manually copy the text.');
            }
        });

        listenTsbReportBtn.addEventListener('click', playTsbReport);
        timelineSlider.addEventListener('input', handleTimelineChange);
        detailedDataHeader.addEventListener('click', () => {
            detailedDataContent.classList.toggle('hidden');
            detailedDataArrow.classList.toggle('rotate-180');
        });
        startOverBtn.addEventListener('click', () => window.location.reload());
        goToTopBtn.addEventListener('click', () => window.scrollTo(0, 0));
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                goToTopBtn.classList.remove('hidden');
            } else {
                goToTopBtn.classList.add('hidden');
            }
        });

        mainControlsHeader.addEventListener('click', toggleMainControls);
        document.addEventListener('keydown', (event) => {
            if (event.target.tagName.toLowerCase() === 'input') return; // Ignore keydown in input fields
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                hideMainControls();
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                showMainControls();
            }
        });


        function handleFile(file) {
            fileNameDisplay.textContent = `Processing: ${file.name}...`;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const worker = new Worker(URL.createObjectURL(new Blob([`
                    (${workerFunction.toString()})()
                `], { type: 'application/javascript' })));

                worker.onmessage = (event) => {
                    if (event.data.error) {
                        handleError(new Error(event.data.error));
                    } else {
                        allData = event.data.sort((a, b) => a.timestamp - b.timestamp);
                        fileNameDisplay.textContent = `File: ${file.name}`;
                        initializeDashboard();
                    }
                    worker.terminate();
                };
                
                worker.postMessage({
                    content: e.target.result,
                    fileType: file.name.split('.').pop().toLowerCase()
                });
            };
            reader.readAsText(file);
        }
        
        function workerFunction() {
            self.onmessage = function(event) {
                const { content, fileType } = event.data;
                try {
                    let data;
                    if (fileType === 'jmx') data = parseJMX(content);
                    else if (fileType === 'csv') data = parseCSV(content);
                    else if (fileType === 'json') data = parseJSON(content);
                    else throw new Error('Unsupported file format.');
                    
                    if (data.length === 0) throw new Error('No sample data found.');
                    
                    self.postMessage(data);
                } catch (e) {
                    self.postMessage({ error: e.message });
                }
            };

            function parseJMX(xmlContent) {
                const sampleTags = [...xmlContent.matchAll(/<(httpSample|sample)\s+([^>]+)>/g)];
                
                return sampleTags.map(tagMatch => {
                    const attributesString = tagMatch[2];
                    const attributes = {};
                    
                    const attrRegex = /(\w+)="([^"]*)"/g;
                    let attrMatch;
                    while ((attrMatch = attrRegex.exec(attributesString)) !== null) {
                        attributes[attrMatch[1]] = attrMatch[2];
                    }
                    
                    return {
                        label: attributes['lb'],
                        sampleTime: parseInt(attributes['t'], 10),
                        success: attributes['s'] === 'true',
                        timestamp: parseInt(attributes['ts'], 10),
                        threadName: attributes['tn'],
                        bytes: parseInt(attributes['by'], 10),
                        sentBytes: parseInt(attributes['sby'], 10),
                        latency: parseInt(attributes['lt'], 10),
                        connectTime: parseInt(attributes['ct'], 10),
                    };
                });
            }

            function parseCSV(csvContent) {
                const lines = csvContent.trim().split('\n');
                const header = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];
                
                const labelIdx = header.indexOf('label');
                const timeIdx = header.indexOf('elapsed');
                const successIdx = header.indexOf('success');
                const timeStampIdx = header.indexOf('timestamp');
                const threadNameIdx = header.indexOf('threadname');
                const bytesIdx = header.indexOf('bytes');
                const sentBytesIdx = header.indexOf('sentbytes');
                const latencyIdx = header.indexOf('latency');
                const connectTimeIdx = header.indexOf('connect');


                if (labelIdx === -1 || timeIdx === -1 || successIdx === -1 || timeStampIdx === -1) {
                    throw new Error('Invalid CSV header. Required columns: timeStamp, elapsed, label, success.');
                }

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length < header.length) continue;
                    data.push({
                        timestamp: parseInt(values[timeStampIdx].trim(), 10),
                        sampleTime: parseInt(values[timeIdx].trim(), 10),
                        label: values[labelIdx].trim().replace(/"/g, ''),
                        success: values[successIdx].trim().toLowerCase() === 'true',
                        threadName: threadNameIdx > -1 ? values[threadNameIdx].trim() : 'N/A',
                        bytes: bytesIdx > -1 ? parseInt(values[bytesIdx].trim(), 10) : 0,
                        sentBytes: sentBytesIdx > -1 ? parseInt(values[sentBytesIdx].trim(), 10) : 0,
                        latency: latencyIdx > -1 ? parseInt(values[latencyIdx].trim(), 10) : 0,
                        connectTime: connectTimeIdx > -1 ? parseInt(values[connectTimeIdx].trim(), 10) : 0,
                    });
                }
                return data;
            }
            function parseJSON(jsonContent) {
                const parsed = JSON.parse(jsonContent);
                if (!Array.isArray(parsed) || !parsed[0] || !('label' in parsed[0])) {
                    throw new Error('Invalid JSON. Expected an array of objects with keys: label, sampleTime, success, timestamp.');
                }
                return parsed;
            }
        }

        function handleError(error) {
            console.error("File processing error:", error);
            fileNameDisplay.textContent = `Error: ${error.message}`;
            dashboardContent.classList.add('hidden');
            mainControlsContainer.classList.remove('hidden');
            timelineContainer.classList.add('hidden');
            noDataMessage.classList.remove('hidden');
        }

        // --- DASHBOARD INITIALIZATION & UPDATES ---
        function initializeDashboard() {
            hideMainControls(); // Collapse controls after file upload
            filtersSection.classList.remove('hidden');
            dashboardContent.classList.remove('hidden');
            timelineContainer.classList.remove('hidden');
            startOverContainer.classList.remove('hidden');
            noDataMessage.classList.add('hidden');
            populateFilters(allData);
            setupTimeline();
            applyFilters();
        }
        
        applyFiltersBtn.addEventListener('click', applyFilters);

        function applyFilters() {
            const labelFilterValue = document.getElementById('label-filter').value;
            const statusFilterValue = document.getElementById('status-filter').value;
            filteredData = allData.filter(item => 
                (labelFilterValue === 'all' || item.label === labelFilterValue) &&
                (statusFilterValue === 'all' || String(item.success) === statusFilterValue)
            );
            currentPage = 1;
            timelineSlider.value = timelineSlider.max;
            handleTimelineChange();
        }

        function updateDashboard(dataToRender = filteredData) {
            if (dataToRender.length === 0) {
                noDataMessage.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
                return;
            }
            noDataMessage.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            
            const processed = processDataForCharts(dataToRender);
            
            renderSummary(processed.summary);
            renderChart('response-time-over-time-chart', getResponseTimeSeries(dataToRender));
            renderChart('throughput-chart', getThroughput(dataToRender));
            renderChart('percentile-chart', getPercentiles(dataToRender));
            renderChart('error-rate-chart', getErrorRates(dataToRender));
            renderChart('success-fail-trend-chart', getSuccessFailTrend(dataToRender));
            renderTable(dataToRender);
            generateInsights(dataToRender, processed);
            updateDynamicThemeAndTimeline(dataToRender);
        }

        // --- DATA PROCESSING ---
        function processDataForCharts(data) {
            const summary = calculateSummaryMetrics(data);
            return { summary };
        }

        // --- METRIC CALCULATIONS ---
        function calculateSummaryMetrics(data) {
            if (data.length === 0) return { totalRequests: 0, totalErrors: 0, avgTime: 0, maxTime: 0, peakThroughput: 0, thresholdBreaches: [] };
            const times = data.map(d => d.sampleTime).filter(t => !isNaN(t));
            if (times.length === 0) return { totalRequests: data.length, totalErrors: data.filter(d => !d.success).length, thresholdBreaches: [] };
            
            const threshold = parseInt(document.getElementById('threshold-input').value, 10) || 0;
            const throughputPerSecond = {};
            let thresholdBreaches = [];

            data.forEach(d => {
                const second = Math.floor(d.timestamp / 1000);
                throughputPerSecond[second] = (throughputPerSecond[second] || 0) + 1;
                if (threshold > 0 && d.sampleTime > threshold) {
                    thresholdBreaches.push(d);
                }
            });

            return {
                totalRequests: data.length,
                totalErrors: data.filter(d => !d.success).length,
                avgTime: times.reduce((a, b) => a + b, 0) / times.length,
                maxTime: Math.max(...times),
                peakThroughput: Math.max(0, ...Object.values(throughputPerSecond)),
                thresholdBreaches: thresholdBreaches
            };
        }

        // --- CHART CONFIGS & RENDERING ---
        function getResponseTimeSeries(data) {
            const byLabel = groupBy(data, 'label');
            const finalDatasets = [];
            const allSpikePoints = []; 

            for (const label in byLabel) {
                const seriesData = byLabel[label];
                if (seriesData.length === 0) continue;

                const times = seriesData.map(d => d.sampleTime);
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                
                const spikeMultiplier = 2.5;
                const absoluteThreshold = 1500;
                const spikeThreshold = avgTime * spikeMultiplier;

                const regularPoints = [];

                seriesData.forEach(d => {
                    const point = { x: d.timestamp, y: d.sampleTime };
                    regularPoints.push(point);
                    if (d.sampleTime > spikeThreshold && d.sampleTime > absoluteThreshold) {
                        allSpikePoints.push({ x: d.timestamp, y: d.sampleTime, label: label }); 
                    }
                });

                finalDatasets.push({
                    type: 'line',
                    label: label,
                    data: regularPoints,
                    borderColor: getRandomColor(),
                    tension: 0.1,
                    pointRadius: 1,
                    order: 1
                });
            }

            if (allSpikePoints.length > 0) {
                finalDatasets.push({
                    type: 'scatter',
                    label: 'Spike',
                    data: allSpikePoints,
                    backgroundColor: 'rgba(239, 68, 68, 1)',
                    pointStyle: 'triangle',
                    radius: 7,
                    hoverRadius: 10,
                    order: 0
                });
            }

            const options = getCommonTimeOptions('Response Time (ms)');
            options.plugins.tooltip = {
                callbacks: {
                    label: function(context) {
                        const value = context.parsed.y;
                        const time = new Date(context.parsed.x).toLocaleTimeString();
                        
                        if (context.dataset.label === 'Spike') {
                            const langTip = translations[currentLang].tips.spikeTooltip || 'Spike: {value}ms at {time}';
                            return langTip.replace('{value}', value).replace('{time}', time);
                        }

                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += `${context.parsed.y} ms`;
                        }
                        return label;
                    }
                }
            };
            
            options.plugins.legend.onClick = (e, legendItem, legend) => {
                const chart = legend.chart;
                Chart.defaults.plugins.legend.onClick.call(this, e, legendItem, legend);

                const spikeDatasetIndex = chart.data.datasets.findIndex(ds => ds.label === 'Spike');
                if (spikeDatasetIndex === -1 || !chart.originalSpikes) {
                    chart.update();
                    return;
                }

                const visibleLabels = new Set();
                legend.legendItems.forEach((item) => {
                    if (!item.hidden && item.text !== 'Spike') {
                        visibleLabels.add(item.text);
                    }
                });

                const isSpikeLegendVisible = !legend.legendItems.find(item => item.text === 'Spike')?.hidden;

                if (isSpikeLegendVisible) {
                    const filteredSpikes = chart.originalSpikes.filter(spike => visibleLabels.has(spike.label));
                    chart.data.datasets[spikeDatasetIndex].data = filteredSpikes;
                } else {
                    chart.data.datasets[spikeDatasetIndex].data = [];
                }
                
                chart.update();
            };

            return {
                data: { datasets: finalDatasets },
                options: options
            };
        }
        
        function getThroughput(data) {
            const throughputPerSecond = {};
            data.forEach(d => {
                const second = Math.floor(d.timestamp / 1000) * 1000;
                throughputPerSecond[second] = (throughputPerSecond[second] || 0) + 1;
            });
            const chartData = Object.entries(throughputPerSecond).map(([ts, count]) => ({ x: parseInt(ts), y: count }));
            return {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Requests/sec',
                        data: chartData,
                        borderColor: '#34d399',
                        fill: true,
                        backgroundColor: 'rgba(52, 211, 153, 0.2)'
                    }]
                },
                options: getCommonTimeOptions('Number of Requests')
            };
        }
        
        function getPercentiles(data) {
            const byLabel = groupBy(data, 'label');
            const labels = Object.keys(byLabel);
            const p90 = [];
            const p95 = [];
            labels.forEach(label => {
                const times = byLabel[label].map(d => d.sampleTime).sort((a,b) => a-b);
                p90.push(times.length > 0 ? times[Math.floor(times.length * 0.9)] : 0);
                p95.push(times.length > 0 ? times[Math.floor(times.length * 0.95)] : 0);
            });
            return {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: '90th Percentile', data: p90, backgroundColor: 'rgba(96, 165, 250, 0.7)' },
                        { label: '95th Percentile', data: p95, backgroundColor: 'rgba(59, 130, 246, 0.7)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Response Time (ms)'
                            }
                        }
                    }
                }
            };
        }
        
        function getErrorRates(data) {
            const byLabel = groupBy(data.filter(d => !d.success), 'label');
            const labels = Object.keys(byLabel);
            const errorCounts = labels.map(label => byLabel[label].length);

            return {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Errors',
                        data: errorCounts,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Errors'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            };
        }
        
        function getSuccessFailTrend(data) {
            const trend = {};
             data.forEach(d => {
                const second = Math.floor(d.timestamp / 1000) * 1000;
                if (!trend[second]) trend[second] = { success: 0, fail: 0 };
                d.success ? trend[second].success++ : trend[second].fail++;
            });
            const successData = [], failData = [];
            Object.entries(trend).sort((a,b) => a[0] - b[0]).forEach(([ts, counts]) => {
                successData.push({ x: parseInt(ts), y: counts.success });
                failData.push({ x: parseInt(ts), y: counts.fail });
            });
            return {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'Success', data: successData, borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.1 },
                        { label: 'Failure', data: failData, borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: true, tension: 0.1 }
                    ]
                },
                options: getCommonTimeOptions('Number of Requests')
            }
        }

        function renderChart(canvasId, config) {
            if (charts[canvasId]) charts[canvasId].destroy();
            const chartWrapper = document.getElementById(canvasId).parentElement.parentElement;
            if (config && config.data && config.data.datasets.some(ds => ds.data && ds.data.length > 0)) {
                chartWrapper.style.display = 'block';
                const chartInstance = new Chart(document.getElementById(canvasId).getContext('2d'), config);
                charts[canvasId] = chartInstance;

                if (canvasId === 'response-time-over-time-chart') {
                    const spikeDataset = config.data.datasets.find(ds => ds.label === 'Spike');
                    chartInstance.originalSpikes = spikeDataset ? [...spikeDataset.data] : [];
                }
                
                chartWrapper.ondblclick = () => {
                    if (maximizedChart) {
                        maximizedChart.destroy();
                    }
                    chartModal.classList.remove('hidden');
                    maximizedChart = new Chart(maximizedChartCanvas, config);
                     if (canvasId === 'response-time-over-time-chart') {
                        maximizedChart.originalSpikes = chartInstance.originalSpikes;
                    }
                };
            } else {
                chartWrapper.style.display = 'none';
            }
        }

        function renderSummary(summary) {
            summaryStatsContainer.innerHTML = `
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600" data-translate-key="totalRequests">Total Requests</p><p class="text-3xl font-bold text-blue-600">${summary.totalRequests || 0}</p></div>
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600" data-translate-key="totalErrors">Total Errors</p><p class="text-3xl font-bold text-red-600">${summary.totalErrors || 0}</p></div>
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600" data-translate-key="avgMaxResponse">Avg / Max Response (ms)</p><p class="text-3xl font-bold text-gray-800">${(summary.avgTime || 0).toFixed(0)} / ${summary.maxTime || 0}</p></div>
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600" data-translate-key="peakThroughput">Peak Throughput (req/s)</p><p class="text-3xl font-bold text-green-600">${summary.peakThroughput || 0}</p></div>
                <div id="threshold-breaches-card" class="summary-card p-4 rounded-lg shadow border cursor-pointer"><p class="text-sm text-gray-600" data-translate-key="thresholdBreaches">Threshold Breaches</p><p class="text-3xl font-bold text-yellow-600">${summary.thresholdBreaches.length || 0}</p></div>
            `;
            
            document.getElementById('threshold-breaches-card').addEventListener('click', () => {
                renderThresholdBreachesTable(summary.thresholdBreaches);
                thresholdModal.classList.remove('hidden');
            });
            updateLanguage(currentLang);
        }

        // --- TABLE & PAGINATION ---
        function renderTable(dataToRender) {
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            const threshold = parseInt(document.getElementById('threshold-input').value, 10);

            const paginatedData = dataToRender.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
            paginatedData.forEach((item, index) => {
                const row = document.createElement('tr');
                if (!item.success) {
                    row.classList.add('error-row');
                } else if (threshold && item.sampleTime > threshold) {
                    row.classList.add('threshold-exceeded-row');
                }
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(item.timestamp).toLocaleTimeString('en-US')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.threadName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.label}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.sampleTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${item.success ? 'text-green-600' : 'text-red-600'}">${item.success ? 'Success' : 'Failure'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.bytes}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.sentBytes}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.latency}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.connectTime}</td>
                `;
                tableBody.appendChild(row);
            });
            renderPaginationControls(dataToRender.length);
        }
        
        function renderThresholdBreachesTable(breaches) {
            const tableBody = document.getElementById('threshold-table-body');
            tableBody.innerHTML = '';
            breaches.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(item.timestamp).toLocaleTimeString('en-US')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.label}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.sampleTime}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderPaginationControls(totalRows) {
            const container = document.getElementById('pagination-controls');
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            container.innerHTML = '';
            if (totalPages <= 1) return;
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50';
            prevButton.onclick = () => { currentPage--; renderTable(filteredData); };
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.className = 'ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50';
            nextButton.onclick = () => { currentPage++; renderTable(filteredData); };
            const pageInfo = document.createElement('span');
            pageInfo.className = 'text-sm text-gray-700';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            const buttonWrapper = document.createElement('div');
            buttonWrapper.appendChild(prevButton);
            buttonWrapper.appendChild(nextButton);
            container.appendChild(pageInfo);
            container.appendChild(buttonWrapper);
        }

        // --- UTILITIES ---
        function populateFilters(data) {
            const labelFilter = document.getElementById('label-filter');
            labelFilter.innerHTML = '<option value="all" data-translate-key="allLabels">All Labels</option>';
            [...new Set(data.map(item => item.label))].forEach(label => {
                const option = document.createElement('option');
                option.value = label;
                option.textContent = label;
                labelFilter.appendChild(option);
            });
            updateLanguage(currentLang);
        }
        
        function getCommonTimeOptions(yAxisTitle) {
            return {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, title: { display: true, text: 'Time' } },
                    y: { beginAtZero: true, title: { display: true, text: yAxisTitle } }
                },
                plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 12, padding: 20 } } }
            };
        }

        function groupBy(arr, key) {
            return arr.reduce((acc, item) => {
                (acc[item[key]] = acc[item[key]] || []).push(item);
                return acc;
            }, {});
        }

        function getRandomColor(alpha = 1) {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        downloadCsvBtn.addEventListener('click', () => {
             if (filteredData.length === 0) { alert('No data to download.'); return; }
            const headers = Object.keys(filteredData[0]).join(',') + '\n';
            const csvContent = filteredData.map(d => Object.values(d).join(',')).join('\n');
            const blob = new Blob([headers + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", "filtered_performance_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function downloadChart(canvasId, filename) {
            const canvas = document.getElementById(canvasId);
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        function generateInsights(data, processedData) {
            const tips = {
                'response-time-tip': '', 'throughput-tip': '', 'error-rate-tip': '', 'percentile-tip': '', 'success-fail-trend-tip': ''
            };
            const summary = processedData.summary;
            const langTips = translations[currentLang].tips;

            if (summary.maxTime > summary.avgTime * 3 && summary.maxTime > 1000) {
                const spike = data.find(d => d.sampleTime === summary.maxTime);
                if (spike) {
                    tips['response-time-tip'] = langTips.responseTimeSpike
                        .replace('{maxTime}', summary.maxTime)
                        .replace('{label}', spike.label)
                        .replace('{time}', new Date(spike.timestamp).toLocaleTimeString())
                        .replace('{avgTime}', summary.avgTime.toFixed(0));
                }
            }

            const errorRate = summary.totalRequests > 0 ? (summary.totalErrors / summary.totalRequests) * 100 : 0;
            if (errorRate > 10) {
                tips['error-rate-tip'] = langTips.highErrorRate.replace('{errorRate}', errorRate.toFixed(1));
            }

            const throughputData = getThroughput(data).data.datasets[0].data;
            if (throughputData.length > 5) {
                const lastPoints = throughputData.slice(-5).map(p => p.y);
                const avgLast = lastPoints.reduce((a, b) => a + b, 0) / lastPoints.length;
                const deviation = Math.sqrt(lastPoints.map(y => Math.pow(y - avgLast, 2)).reduce((a, b) => a + b, 0) / lastPoints.length);
                if (deviation < avgLast * 0.1 && avgLast > 0) {
                    tips['throughput-tip'] = langTips.throughputCapped.replace('{avgThroughput}', avgLast.toFixed(0));
                }
            }
            
            const percentileData = getPercentiles(data);
            if(percentileData.data.labels.length > 0) {
                const p95s = percentileData.data.datasets[1].data;
                const maxP95 = Math.max(...p95s);
                if (maxP95 > 2000) {
                    const maxIndex = p95s.indexOf(maxP95);
                    const label = percentileData.data.labels[maxIndex];
                    tips['percentile-tip'] = langTips.percentileHigh.replace('{label}', label).replace('{p95}', maxP95);
                }
            }

            const trendData = getSuccessFailTrend(data).data.datasets[1].data;
            if (trendData.length > 2) {
                 const lastFailure = trendData[trendData.length - 1].y;
                 const prevFailure = trendData[trendData.length - 2].y;
                 if (lastFailure > prevFailure * 2 && lastFailure > 5) {
                     tips['success-fail-trend-tip'] = langTips.successFailFluctuation;
                 }
            }

            const showTips = toggleTipsCheckbox.checked;
            for (const [id, tip] of Object.entries(tips)) {
                const el = document.getElementById(id);
                if (el) {
                    if (tip && showTips) {
                        el.textContent = tip;
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'none';
                    }
                }
            }
        }
        
        async function getTsbInsights() {
            if (filteredData.length === 0) {
                alert("Please upload and filter data first.");
                return;
            }

            tsbInsightsModal.classList.remove('hidden');
            tsbLoader.style.display = 'flex';
            tsbInsightsContent.style.display = 'none';
            tsbModalFooter.classList.add('hidden');
            listenTsbReportBtn.classList.add('hidden');
            tsbInsightsContent.innerHTML = '';

            const summary = calculateSummaryMetrics(filteredData);
            const dataSummaryForPrompt = `
                - Total Requests: ${summary.totalRequests}
                - Total Errors: ${summary.totalErrors}
                - Average Response Time: ${summary.avgTime.toFixed(2)} ms
                - Maximum Response Time: ${summary.maxTime} ms
                - Peak Throughput: ${summary.peakThroughput.toFixed(2)} requests/second
                - Number of requests over threshold: ${summary.thresholdBreaches.length}
            `;

            const language = currentLang === 'vi' ? 'Vietnamese' : 'English';
            const prompt = `Act as a top-tier management consultant from a firm like McKinsey. Analyze the following summary of a load test and provide a professional, structured report in ${language}. Start the report with the title "## Performance Assessment Report: Load Test Analysis". Do not add any other introductory phrases or headers before this title. The report should contain three sections: 1. Executive Summary, 2. Key Findings (with data points), and 3. Actionable Recommendations. The summary is as follows: \n${dataSummaryForPrompt}`;
            
            try {
                const text = await callGeminiAPI(prompt);
                
                const logDate = filteredData.length > 0 ? new Date(filteredData[0].timestamp) : new Date();
                const analyzeDate = new Date();
                const formattedLogDate = analyzeDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const formattedAnalyzeDate = analyzeDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                const reportHeader = `
                    <p><strong>Prepared For:</strong> [Client Name/Team]</p>
                    <p><strong>Log Date:</strong> ${formattedLogDate}</p>
                    <p><strong>Analyze Date:</strong> ${formattedAnalyzeDate}</p>
                    <p><strong>Prepared By:</strong> TSB</p>
                    <hr style="margin: 1rem 0;">
                `;
                
                const titleRegex = /(<br>)*(##? Performance Assessment Report: Load Test Analysis)/i;
                const match = text.match(titleRegex);
                let reportBody = text;
                let reportTitle = '';

                if (match) {
                    reportTitle = `<h2>${match[2].replace(/##? /,'')}</h2>`;
                    reportBody = text.replace(titleRegex, '');
                }

                tsbInsightsContent.innerHTML = reportTitle + reportHeader + reportBody.replace(/\n/g, '<br>').replace(/\*\*/g, '<strong>').replace(/\*/g, '<em>');

            } catch (error) {
                console.error("Error calling TSB API:", error);
                tsbInsightsContent.innerHTML = `<p class="text-red-500">Sorry, an error occurred while generating insights. Please try again. Details: ${error.message}</p>`;
            } finally {
                tsbLoader.style.display = 'none';
                tsbInsightsContent.style.display = 'block';
                tsbModalFooter.classList.remove('hidden');
                listenTsbReportBtn.classList.remove('hidden');
            }
        }
        
        async function callGeminiAPI(prompt) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyDVqQazlPiOALxXFF3eukRL_Bx2C5Qwtjs";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API call failed with status: ${response.status}. Response: ${errorText}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            }
            return 'No insights generated.';
        }


        // --- LANGUAGE & TRANSLATION ---
        const translations = {
            en: {
                dashboardTitle: "Performance Analysis Dashboard Tool", dashboardSubtitle: "Upload a results file (.jmx, .csv, .json) to explore performance data.",
                uploadTitle: "Upload Results File(s)", clickToUpload: "Click to upload", orDragAndDrop: "or drag and drop", supportedFiles: "Supports .jmx, .csv, .json files",
                helpTitle: "Need help reading the charts?", helpSubtitle: "Click the button below for a detailed guide on how to interpret the performance data.", understandChartsBtn: "Understand The Charts",
                setupAndFiltersTitle: "Setup, Filters & Export", filtersTitle: "Data Filters & Export", filterByLabel: "Filter by Label", filterByStatus: "Filter by Status", allLabels: "All Labels", statusAll: "All", statusSuccess: "Success", statusFailure: "Failure",
                responseTimeThreshold: "Threshold (ms)", applyBtn: "Apply", showAssistantTips: "Show Assistant Tips",
                exportPdfBtn: "Export PDF", tsbAnalysisBtn: "✨ Analyze with TSB",
                totalRequests: "Total Requests", totalErrors: "Total Errors", avgMaxResponse: "Avg / Max Response (ms)", peakThroughput: "Peak Throughput (req/s)", thresholdBreaches: "Threshold Breaches",
                responseTimeChartTitle: "Response Time Over Time (by Label)", throughputChartTitle: "Throughput (Requests/sec)", percentilesChartTitle: "90th/95th Percentiles by Label", errorDistributionChartTitle: "Error Distribution by Label", successFailTrendChartTitle: "Success vs. Failure Trend",
                savePngBtn: "Save PNG", detailedDataTitle: "Detailed Data", downloadCsvBtn: "Download CSV",
                tableStartTime: "Start Time", tableThreadName: "Thread Name", tableLabel: "Label", tableSampleTime: "Sample Time (ms)", tableStatus: "Status", tableBytes: "Bytes", tableSentBytes: "Sent Bytes", tableLatency: "Latency", tableConnectTime: "Connect Time (ms)",
                noDataMessage: "No valid data found in the uploaded file.", thresholdBreachesTitle: "Threshold Breaches", tsbAnalysisTitle: "✨ Analyze with TSB",
                exportDocBtn: "Copy for Google Docs", copyInstructions: "Click the button to copy the report and open a new Google Doc for pasting.", copiedToClipboard: "Copied!",
                replayTimelineTitle: "Replay Timeline", listenBtn: "🔊 Listen", startOverBtn: "Start Over",
                goToTopBtn: "Go to Top",
                footer_copyright: "&copy; 2025 Performance Analysis Dashboard by TSB. All Rights Reserved.",
                quotes: ["Every number tells a story – uncover it.", "Performance speaks louder than promises.", "Good data, great decisions.", "Metrics don’t lie. They whisper insights."],
                tips: {
                    responseTimeSpike: '⚠️ Response time spiked to {maxTime}ms for "{label}" at {time}. This is significantly higher than the average of {avgTime}ms.',
                    highErrorRate: '🔴 The overall error rate is {errorRate}%, which is high. Check the error distribution chart for problematic requests.',
                    throughputCapped: '⚠️ Throughput appears to have capped at around {avgThroughput} req/sec, suggesting a potential system bottleneck.',
                    percentileHigh: '📈 The 95th percentile for "{label}" is {p95}ms, indicating that 5% of requests are slower than this value.',
                    successFailFluctuation: '📉 Note the fluctuations between successful and failed requests. A sudden increase in failures could indicate a problem.',
                    spikeTooltip: 'Spike Detected: {value}ms at {time}'
                }
            },
            vi: {
                dashboardTitle: "Bảng điều khiển Phân tích Hiệu suất", dashboardSubtitle: "Tải lên tệp kết quả (.jmx, .csv, .json) để khám phá dữ liệu hiệu suất.",
                uploadTitle: "Tải lên tệp kết quả", clickToUpload: "Nhấn để tải lên", orDragAndDrop: "hoặc kéo và thả", supportedFiles: "Hỗ trợ các tệp .jmx, .csv, .json",
                helpTitle: "Cần trợ giúp đọc biểu đồ?", helpSubtitle: "Nhấp vào nút bên dưới để có hướng dẫn chi tiết về cách diễn giải dữ liệu hiệu suất.", understandChartsBtn: "Hiểu các biểu đồ",
                setupAndFiltersTitle: "Cài đặt, Bộ lọc & Xuất", filtersTitle: "Bộ lọc dữ liệu & Xuất", filterByLabel: "Lọc theo nhãn", filterByStatus: "Lọc theo trạng thái", allLabels: "Tất cả các nhãn", statusAll: "Tất cả", statusSuccess: "Thành công", statusFailure: "Thất bại",
                responseTimeThreshold: "Ngưỡng (ms)", applyBtn: "Áp dụng", showAssistantTips: "Hiển thị Mẹo trợ lý",
                exportPdfBtn: "Xuất PDF", tsbAnalysisBtn: "✨ Phân tích với TSB",
                totalRequests: "Tổng số yêu cầu", totalErrors: "Tổng số lỗi", avgMaxResponse: "Phản hồi TB / Tối đa (ms)", peakThroughput: "Thông lượng đỉnh (req/s)", thresholdBreaches: "Vi phạm ngưỡng",
                responseTimeChartTitle: "Thời gian phản hồi theo thời gian (theo nhãn)", throughputChartTitle: "Thông lượng (Yêu cầu/giây)", percentilesChartTitle: "Phân vị 90/95 theo nhãn", errorDistributionChartTitle: "Phân phối lỗi theo nhãn", successFailTrendChartTitle: "Xu hướng thành công và thất bại",
                savePngBtn: "Lưu PNG", detailedDataTitle: "Dữ liệu chi tiết", downloadCsvBtn: "Tải xuống CSV",
                tableStartTime: "Thời gian bắt đầu", tableThreadName: "Tên luồng", tableLabel: "Nhãn", tableSampleTime: "Thời gian mẫu (ms)", tableStatus: "Trạng thái", tableBytes: "Bytes", tableSentBytes: "Bytes đã gửi", tableLatency: "Độ trễ", tableConnectTime: "Thời gian kết nối (ms)",
                noDataMessage: "Không tìm thấy dữ liệu hợp lệ trong tệp đã tải lên.", thresholdBreachesTitle: "Vi phạm ngưỡng", tsbAnalysisTitle: "✨ Phân tích từ TSB",
                exportDocBtn: "Sao chép cho Google Docs", copyInstructions: "Nhấp vào nút để sao chép báo cáo và mở một Google Doc mới để dán.", copiedToClipboard: "Đã sao chép!",
                replayTimelineTitle: "Dòng thời gian phát lại", listenBtn: "🔊 Nghe", startOverBtn: "Bắt đầu lại",
                goToTopBtn: "Lên trên cùng",
                footer_copyright: "&copy; 2025 Bảng điều khiển Phân tích Hiệu suất bởi TSB. Bảo lưu mọi quyền.",
                quotes: ["Mỗi con số kể một câu chuyện – hãy khám phá nó.", "Hiệu suất nói lên nhiều điều hơn lời hứa.", "Dữ liệu tốt, quyết định tuyệt vời.", "Số liệu không nói dối. Chúng thì thầm những hiểu biết."],
                tips: {
                    responseTimeSpike: '⚠️ Thời gian phản hồi tăng vọt lên {maxTime}ms cho "{label}" vào lúc {time}. Con số này cao hơn đáng kể so với mức trung bình là {avgTime}ms.',
                    highErrorRate: '🔴 Tỷ lệ lỗi tổng thể là {errorRate}%, mức này là cao. Kiểm tra biểu đồ phân phối lỗi để tìm các yêu cầu có vấn đề.',
                    throughputCapped: '⚠️ Thông lượng dường như đã đạt đỉnh ở khoảng {avgThroughput} req/giây, cho thấy có thể có điểm nghẽn hệ thống.',
                    percentileHigh: '📈 Phân vị thứ 95 cho "{label}" là {p95}ms, cho thấy 5% yêu cầu chậm hơn giá trị này.',
                    successFailFluctuation: '📉 Lưu ý sự biến động giữa các yêu cầu thành công và thất bại. Sự gia tăng đột ngột của các lỗi có thể chỉ ra một vấn đề.',
                    spikeTooltip: 'Phát hiện đột biến: {value}ms lúc {time}'
                }
            }
        };

        function updateLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.dataset.translateKey;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'BUTTON' && element.id === 'go-to-top-btn') {
                        element.title = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            if (quoteInterval) clearInterval(quoteInterval);

            const footerCopyright = document.getElementById('footer-copyright');
            const footerQuote = document.getElementById('footer-quote');
            if (translations[lang] && translations[lang].footer_copyright) {
                footerCopyright.innerHTML = translations[lang].footer_copyright;
            }
            if (translations[lang] && translations[lang].quotes) {
                const quotes = translations[lang].quotes;
                const setRandomQuote = () => {
                    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                    footerQuote.textContent = `"${randomQuote}"`;
                };
                setRandomQuote();
                quoteInterval = setInterval(setRandomQuote, 5000);
            }
        }

        // --- NEW/MODIFIED FEATURE IMPLEMENTATIONS ---

        function playTsbReport() {
            if (typeof SpeechSynthesisUtterance === 'undefined' || typeof window.speechSynthesis === 'undefined') {
                alert('Sorry, your browser does not support text-to-speech.');
                return;
            }
            window.speechSynthesis.cancel();

            const textToSpeak = tsbInsightsContent.innerText;
            if (!textToSpeak.trim()) {
                alert("No report content to read.");
                return;
            }

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = currentLang === 'vi' ? 'vi-VN' : 'en-US';
            window.speechSynthesis.speak(utterance);
        }

        function setupTimeline() {
            if (allData.length === 0) return;
            const firstTs = allData[0].timestamp;
            const lastTs = allData[allData.length - 1].timestamp;
            timelineSlider.min = firstTs;
            timelineSlider.max = lastTs;
            timelineSlider.value = lastTs;
            timelineLabel.textContent = new Date(parseInt(timelineSlider.value)).toLocaleString();
        }

        function handleTimelineChange() {
            const timestamp = parseInt(timelineSlider.value);
            timelineLabel.textContent = new Date(timestamp).toLocaleString();
            const dataSubset = filteredData.filter(d => d.timestamp <= timestamp);
            updateDashboard(dataSubset);
        }

        function updateDynamicThemeAndTimeline(dataSubset) {
            if (!dataSubset || dataSubset.length === 0) {
                timelineSlider.style.background = '#ddd';
                bgOverlay.style.backgroundColor = 'rgba(0, 20, 80, 0.5)';
                return;
            }
            
            const summary = calculateSummaryMetrics(dataSubset);
            const errorRate = summary.totalRequests > 0 ? (summary.totalErrors / summary.totalRequests) : 0;
            
            let color, bgColor;
            if (errorRate >= 0.05) {
                color = '#ef4444'; // Red
                bgColor = 'rgba(255, 0, 0, 0.6)';
            } else if (errorRate >= 0.01) {
                color = '#f59e0b'; // Yellow
                bgColor = 'rgba(255, 255, 0, 0.5)';
            } else {
                color = '#16a34a'; // Green
                bgColor = 'rgba(0, 255, 0, 0.4)';
            }

            // Update Timeline Slider
            const progress = ((timelineSlider.value - timelineSlider.min) / (timelineSlider.max - timelineSlider.min)) * 100;
            timelineSlider.style.background = `linear-gradient(to right, ${color} ${progress}%, #ddd ${progress}%)`;

            // Update Background Overlay
            bgOverlay.style.backgroundColor = bgColor;
        }

        function toggleMainControls() {
            mainControlsContent.classList.toggle('hidden');
            mainControlsArrow.classList.toggle('rotate-180');
        }

        function showMainControls() {
            mainControlsContent.classList.remove('hidden');
            mainControlsArrow.classList.add('rotate-180');
        }

        function hideMainControls() {
            mainControlsContent.classList.add('hidden');
            mainControlsArrow.classList.remove('rotate-180');
        }


        // --- INITIAL LOAD ---
        updateLanguage(currentLang);
        
        // --- SOURCE CODE PROTECTION ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', event => {
            if (event.key === 'F12' || 
               (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key.toUpperCase())) ||
               (event.ctrlKey && event.key.toUpperCase() === 'U')) {
                event.preventDefault();
            }
        });

    </script>

</body>
</html>
